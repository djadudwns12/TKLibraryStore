<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.tn.mapper.OrderMapper">
  	
 
<!-- 박근영 -->
	<select id="selectUserAddress" resultType="com.tn.order.model.vo.AddressVO">
		SELECT receiver_name, address_key, receiver_phone, address, isDefault, request FROM Address WHERE userId = #{userId}
	</select>
	
	<select id="selectUserPoint" resultType="int">
		SELECT userPoint FROM Member WHERE userId = #{userId}
	</select>	
	
	<insert id="insertPaymentComplete" parameterType="com.tn.order.model.dto.PaymentInfoDTO">
	    INSERT INTO `Order` (orderStatus, orderWho, orderAddress, usePoint, totalPay, orderNo)
	    VALUES (
	        '배송중', 
	        #{userId}, 
	        #{address}, 
	        <choose>
	            <when test="finalInputPoint != null">
	                #{finalInputPoint}
	            </when>
	            <otherwise>
	                0
	            </otherwise>
	        </choose>,
	        #{totalAmount}, 
	        #{paymentId}
	    );
	</insert>



 	<select id="selectOrderBookNo" parameterType="com.tn.order.model.dto.PaymentInfoDTO" resultType="com.tn.order.model.vo.PaymentInfoVO">
		SELECT bookNo FROM Cart WHERE cartId IN <foreach item="cartId" 
		collection="cartId" open="(" separator="," close=")" >#{cartId}</foreach> AND userId = #{userId}
	</select>
<!-- 박근영 -->
<!-- 엄영준 -->
    <!-- 회원이 주문한 목록 최근꺼 3개를 가지고 오는 쿼리문 -->
	<select id="selectRecentOrderList"
		resultType="com.tn.booklist.model.vo.BooklistVO">
		<!-- select b.* from
		(select o.orderPk , o.bookNo from mbcac2024.Order o inner Join Member m on
		o.orderWho = m.userId where o.orderWho = #{userId}) as userOrder
		inner join BookList b
		on userOrder.bookNo = b.bookNo order by userOrder.orderPk desc limit
		0,3; -->
		select b.* from
		(select o.orderPk , o.bookNo from (select ob.bookNo , o.orderPK ,o.orderWho from mbcac2024.Order o inner join OrderBook ob on o.orderNo = ob.orderNo) o inner Join Member m on
		o.orderWho = m.userId where o.orderWho = #{userId}) as userOrder
		inner join BookList b
		on userOrder.bookNo = b.bookNo order by userOrder.orderPk desc limit
		0,3;
	</select>
	<select id="selectMyPageOrderList" resultType="com.tn.order.model.vo.OrderVO">
		SELECT * FROM mbcac2024.Order where orderWho = #{userId} and orderStatus = '배송중'
	</select>
	<select id="selectDetailOrder" resultType="com.tn.order.model.vo.OrderDetailVO">
		select ob.orderNo, ob.qty,b.thumbNail,b.title,b.author,b.salePrice
			from OrderBook ob inner join BookList b
			on ob.bookNo = b.bookNo
			where ob.orderNo = #{orderNo}
	</select>
	
	<update id="updateOrderCancel" parameterType="list">
  			update mbcac2024.Order set orderStatus = '취소요청' where orderNo in 
  			<foreach collection="list" item="orderNo" open="(" separator="," close=")">
    			#{orderNo}
  			</foreach>
  	</update>
	
	
	

</mapper>